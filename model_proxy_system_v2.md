# 模型转发与员工管理系统设计文档（前后端分离版）

## 概述

本系统由 **CLI 工具 + 管理系统（前后端分离） + 模型代理服务**
组成，实现： - 模型统一代理与 Key 隐藏 -
多账号负载分摊（降低封号风险） - 员工权限管理、每日额度限制 -
模型管理（Key、启用状态、QPS） - 使用量监控、日志审计

------------------------------------------------------------------------

# 1. CLI 工具（类似 Gemini CLI）

## 1.1 功能说明

-   发布为 npm 包，Node.js CLI 工具
-   支持 `auto` 模型选择（后台自动选择）
-   支持从后台拉取可用模型列表并主动切换
-   CLI 需要配置 `employeeId`
-   所有模型请求均由 CLI 转发到 **代理服务**

## 1.2 CLI 工作流程

    员工执行命令 → CLI 调管理后台接口拉取配置信息
                 → CLI 调用代理服务 /proxy
                 → 代理服务选择模型 → 转发至真实模型 API
                 → 返回给 CLI

## 1.3 CLI 文件结构示例

    cli/
      ├─ bin/cli.js
      ├─ src/
      │   ├─ config.ts
      │   ├─ api.ts
      │   ├─ command-run.ts
      │   └─ utils/
      └─ package.json

------------------------------------------------------------------------

# 2. 管理系统（前后端分离）

### 前端：React + Ant Design Pro + UmiJS

### 后端：Egg.js + MySQL（REST API 方式）

------------------------------------------------------------------------

# 2.1 前后端分离架构说明

    浏览器（React 前端） → 调用后端 REST API（Egg.js）
    CLI 工具 → 调用后端 REST API（同一套系统）

前端部署：Nginx / Vercel / 静态资源服务器\
后端部署：Node + Egg.js （独立节点）\
两者通过 HTTPS 通信

------------------------------------------------------------------------

# 2.2 鉴权方案

采用 **JWT（管理员、员工分离权限）**：

-   管理员登录后端 → 获取 `admin_token`
-   CLI 使用员工 ID + Token 注册/登录 → 获取 `user_token`
-   前端与 CLI 均通过 `Authorization: Bearer xxx` 访问后端 API

------------------------------------------------------------------------

# 2.3 管理系统功能模块

## 员工管理

-   创建员工账户（账号、姓名、邮箱）
-   编辑员工信息
-   禁用/拉黑账户（立即禁用模型调用）
-   重置 token

## 模型管理

-   新增模型（名称、提供商、API Key、类型）
-   设置 QPS、启用/禁用模型
-   管理多个 Key（轮询使用）

## 权限管理

-   为每名员工配置可用模型
-   每日调用上限设置
-   每个模型可配置独立额度

## 监控后台

-   员工调用次数统计
-   Token 消耗统计
-   模型 Key 使用分布
-   异常流量报警（如调太快）

------------------------------------------------------------------------

# 2.4 后端数据库表结构（MySQL）

## user（员工/管理员表）

  字段       类型      说明
  ---------- --------- -----------------
  id         int       主键
  name       varchar   名称
  email      varchar   登录名
  password   varchar   密码（加密）
  role       tinyint   0=员工 1=管理员
  status     tinyint   0正常 1禁用

## model（模型表）

  字段        类型      说明
  ----------- --------- ----------------------------------
  id          int       主键
  name        varchar   模型名称
  provider    varchar   openai / gemini / claude / local
  api_key     varchar   Key
  enabled     tinyint   启用/关闭
  qps_limit   int       QPS 限制

## user_model_permission（员工-模型权限表）

  字段          类型   说明
  ------------- ------ --------------
  id            int    
  user_id       int    
  model_id      int    
  daily_limit   int    每日限定次数

## usage_log（调用日志表）

  字段         类型       说明
  ------------ ---------- ------
  id           int        
  user_id      int        
  model_id     int        
  tokens       int        
  created_at   datetime   

------------------------------------------------------------------------

# 3. 模型代理服务（集成 Egg.js）

## 3.1 请求示例（CLI 调用）

    POST /api/proxy
    {
      "userId": "123",
      "model": "auto",
      "prompt": "Hello"
    }

## 3.2 后端处理流程（关键逻辑）

1.  校验 user 是否存在 & 未禁用\
2.  检查是否超出每日限额\
3.  模型选择
    -   auto → 按轮询 / 权重 / 随机 / 后续可扩展 AI 选择\
    -   指定模型 → 校验权限\
4.  转发请求给实际模型\
5.  记录调用日志（tokens）\
6.  返回响应给 CLI

------------------------------------------------------------------------

# 4. 系统架构总览（前后端分离）

    +-------------------+       +---------------------+       +------------------------------+
    |   React 前端       | <---> |  Egg.js 后端 API      | <---> | 模型 API (OpenAI/Gemini/…） |
    +-------------------+       +---------------------+       +------------------------------+
               ^
               |（配置信息、模型列表）
               |
         +-----------+
         |  CLI 工具  |
         +-----------+

------------------------------------------------------------------------

# 5. 完整系统特点总结

-   支持多人独立使用模型，不暴露 Key\
-   多 Key 自动负载均衡，降低封号风险\
-   权限可控（每个员工可用哪些模型）\
-   支持每日额度限制\
-   可扩展成 AI 自动选择最佳模型\
-   CLI、前端、后端全部前后端分离设计

------------------------------------------------------------------------

# 6. 文件版本

版本：v2（补充前后端分离架构）
