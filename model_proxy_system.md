# 模型转发与员工管理系统设计文档

## 1. CLI 工具设计（类似 Gemini CLI）

### 功能要求

-   作为 npm 包安装（Node.js CLI）
-   员工需配置自身 ID（从管理系统获取）
-   支持 auto 模型选择（后台随机或智能决策）
-   支持手动指定模型（模型列表来自管理后台授权）
-   从管理系统实时拉取可用模型与剩余额度
-   模型调用全部走你的模型代理服务

### CLI 目录结构示例

    cli/
      ├─ bin/cli.js
      ├─ src/
      │   ├─ config.ts
      │   ├─ api.ts
      │   ├─ command-run.ts
      │   └─ utils/
      └─ package.json

------------------------------------------------------------------------

## 2. 管理系统设计

技术栈：**Egg.js + MySQL + React + Ant Design Pro + UmiJS**

### 2.1 管理员功能列表

-   员工管理
    -   新增员工\
    -   编辑员工\
    -   禁用/拉黑员工（立即阻断 CLI 使用）
-   模型管理
    -   新增模型（名称、提供商、类型、Key、QPS 限制）\
    -   编辑模型\
    -   启用/禁用模型
-   权限与额度管理
    -   指定每个员工可用的模型（权限列表）\
    -   每日调用次数限制（如 100 次/日）\
    -   后端负责计数与限流
-   监控面板
    -   查看员工调用日志\
    -   查看每日模型使用量\
    -   查看 Key 的使用分布\
    -   异常报警（如短时间内异常调用）

### 2.2 数据库表结构设计（简化）

#### user（员工表）

  字段     类型      说明
  -------- --------- ---------------------
  id       int       主键
  name     varchar   名称
  email    varchar   登录账号
  status   tinyint   0 正常 1 拉黑
  role     tinyint   0 普通用户 1 管理员

#### model（模型配置表）

  字段       类型      说明
  ---------- --------- -------------------------------
  id         int       主键
  name       varchar   模型名称
  provider   varchar   openai/anthropic/google/local
  api_key    varchar   对应 key
  enabled    tinyint   启用状态

#### user_model_permission（模型权限表）

  字段          类型   说明
  ------------- ------ ----------
  id            int    
  user_id       int    
  model_id      int    
  daily_limit   int    每日限额

#### usage_log（使用日志表）

  字段         类型       说明
  ------------ ---------- ------
  id           int        
  user_id      int        
  model_id     int        
  tokens       int        
  created_at   datetime   

------------------------------------------------------------------------

## 3. 模型代理服务（可集成到 Egg.js）

### 提供的接口

    POST /api/proxy
    {
      userId: "xxx",
      model: "auto" | "指定模型",
      prompt: "...",
    }

### 转发逻辑

1.  校验 userId 是否存在与未拉黑\
2.  判断是否超出每日限额\
3.  选择模型
    -   auto：随机 / 轮询 / 后续扩展 AI 选择\
    -   手动：验证用户是否有权限\
4.  将请求转发至真实模型 API\
5.  记录调用日志（tokens、模型、时间）

------------------------------------------------------------------------

## 4. 系统整体架构图（描述）

            +-------------+             +------------------+
            |   CLI 工具   |  <--API-->  |   管理系统(后端)   |
            +-------------+             +------------------+
                     |                             |
                     |  调用代理API                 |
                     v                             |
            +------------------+                   |
            | 模型代理/转发服务   |-------------------+
            +------------------+
                     |
                     v
        +--------------------------------+
        |  OpenAI / Gemini / Claude / 本地模型 |
        +--------------------------------+

------------------------------------------------------------------------

## 5. 方案总结

### 整体特点

-   CLI 由 Node.js 实现，无明显性能瓶颈（主要工作是请求外部 API）\
-   Egg.js 可稳定承担企业级模型代理与权限管理\
-   支持团队多人独立使用密钥而不暴露 Key\
-   降低模型账户被封风险\
-   可扩展 AI 自动选择最优模型

------------------------------------------------------------------------
